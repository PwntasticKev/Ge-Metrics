#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-commit checks..."
echo "ğŸš¨ ZERO TOLERANCE: All components MUST have tests!"

# Run TypeScript check
echo "ğŸ“ Checking TypeScript..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "âŒ TypeScript check failed. Please fix errors before committing."
  exit 1
fi

# Run ESLint
echo "ğŸ” Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ ESLint check failed. Please fix errors before committing."
  exit 1
fi

# Check for missing test files (100% component coverage required)
echo "ğŸ§ª Checking for missing test files..."
node scripts/audit-tests.js
if [ $? -ne 0 ]; then
  echo "âŒ Test coverage audit failed. All components MUST have test files."
  echo "ğŸ’¡ Create missing tests with: npm run test:create <component-path>"
  exit 1
fi

# Run all unit tests
echo "ğŸ§ª Running unit tests..."
npm run test:unit:run
if [ $? -ne 0 ]; then
  echo "âŒ Tests failed. Please fix failing tests before committing."
  echo "ğŸ’¡ Run tests in watch mode: npm run test:watch"
  exit 1
fi

# Check test coverage thresholds
echo "ğŸ“Š Checking test coverage thresholds..."
npm run test:coverage
if [ $? -ne 0 ]; then
  echo "âŒ Coverage thresholds not met. Required: 80% lines, 70% branches"
  echo "ğŸ’¡ Add more tests to increase coverage."
  exit 1
fi

# Verify all tests actually test the requirements
echo "ğŸ” Validating test quality..."
echo "âš ï¸  Make sure your tests cover:"
echo "   - Component renders âœ“"
echo "   - Props handling âœ“" 
echo "   - Loading states âœ“"
echo "   - Error states âœ“"
echo "   - User interactions âœ“"
echo "   - Accessibility âœ“"
echo "   - Mobile responsive âœ“"

echo "âœ… All pre-commit checks passed!"
echo "ğŸ‰ Ready to commit with 100% test coverage!"