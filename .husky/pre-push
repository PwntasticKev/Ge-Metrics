#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üöÄ Running pre-push checks..."

# Check task tracking status
echo "üìã Checking task tracking..."
if [ -f "scripts/validate-tasks.cjs" ]; then
  node scripts/validate-tasks.cjs
  if [ $? -ne 0 ]; then
    echo "‚ö†Ô∏è  Warning: Task tracking validation failed"
    echo "   Ensure all tasks are properly documented in TASKS.md"
  fi
fi

# Run full test suite
echo "üß™ Running full test suite..."
npm run test:unit -- --run
if [ $? -ne 0 ]; then
  echo "‚ùå Tests failed. Please fix failing tests before pushing."
  exit 1
fi

# Run integration tests if available
if [ -f "npm run test:integration" ]; then
  echo "üîó Running integration tests..."
  npm run test:integration
  if [ $? -ne 0 ]; then
    echo "‚ùå Integration tests failed."
    exit 1
  fi
fi

# Check bundle size
echo "üì¶ Checking bundle size..."
npm run build
if [ $? -ne 0 ]; then
  echo "‚ùå Build failed. Please fix build errors before pushing."
  exit 1
fi

# Verify TASKS.md is up to date
if git diff --name-only HEAD origin/$(git rev-parse --abbrev-ref HEAD) 2>/dev/null | grep -q "TASKS.md"; then
  echo "‚úÖ TASKS.md has been updated"
else
  echo "‚ö†Ô∏è  Warning: TASKS.md may not be up to date"
  echo "   Consider running: git add TASKS.md && git commit -m 'chore: update task tracking'"
fi

echo "‚úÖ All pre-push checks passed!"